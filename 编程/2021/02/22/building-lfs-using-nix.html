<!DOCTYPE html>
<html lang="en">
<meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src 'self'; style-src 'self' https://fonts.googleapis.com; img-src 'self'; font-src 'self' https://fonts.gstatic.com; connect-src 'self'; media-src 'self'; object-src 'self'; child-src 'self'; form-action 'none'; base-uri 'self'" />
<meta http-equiv="X-XSS-Protection"  content="1;mode=block" always>
<meta http-equiv="Referrer-Policy" content="no-referrer, strict-origin-when-cross-origin"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>使用Nix构建LFS</title><!-- Begin Jekyll SEO tag v2.7.1 -->
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="使用Nix构建LFS" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="前言 前面讲了如何使用Nix创建一个Blog，作为讲如何用Nix打包的过渡。最近这段时间我在用Nix打包Linux From Scratch以及使用Nix仿照NixOS的操作系统模块来编写属于我自己的Linux发行版配置，借着这个契机，在这讲一下如何使用Nix打包。" />
<meta property="og:description" content="前言 前面讲了如何使用Nix创建一个Blog，作为讲如何用Nix打包的过渡。最近这段时间我在用Nix打包Linux From Scratch以及使用Nix仿照NixOS的操作系统模块来编写属于我自己的Linux发行版配置，借着这个契机，在这讲一下如何使用Nix打包。" />
<link rel="canonical" href="https://c4dr01d.github.io/%E7%BC%96%E7%A8%8B/2021/02/22/building-lfs-using-nix.html" />
<meta property="og:url" content="https://c4dr01d.github.io/%E7%BC%96%E7%A8%8B/2021/02/22/building-lfs-using-nix.html" />
<meta property="og:site_name" content="c4droid’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-02-22T21:19:37+08:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="使用Nix构建LFS" />
<script type="application/ld+json">
{"description":"前言 前面讲了如何使用Nix创建一个Blog，作为讲如何用Nix打包的过渡。最近这段时间我在用Nix打包Linux From Scratch以及使用Nix仿照NixOS的操作系统模块来编写属于我自己的Linux发行版配置，借着这个契机，在这讲一下如何使用Nix打包。","headline":"使用Nix构建LFS","dateModified":"2021-02-22T21:19:37+08:00","datePublished":"2021-02-22T21:19:37+08:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://c4dr01d.github.io/%E7%BC%96%E7%A8%8B/2021/02/22/building-lfs-using-nix.html"},"url":"https://c4dr01d.github.io/%E7%BC%96%E7%A8%8B/2021/02/22/building-lfs-using-nix.html","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" type="text/css" href="/assets/main-hacker.css"></head>
<body>
    <div class="container"><header>
  <div class="menu">
    <ul><li><a href="/">c4droid&#39;s Blog</a></li><li><a href="/about/">About</a></li></ul>
  </div>
</header>
<main>
      <h1 id="前言">前言</h1>
<p>前面讲了如何使用Nix创建一个Blog，作为讲如何用Nix打包的过渡。最近这段时间我在用Nix打包Linux From Scratch以及使用Nix仿照NixOS的操作系统模块来编写属于我自己的Linux发行版配置，借着这个契机，在这讲一下如何使用Nix打包。</p>

<h2 id="fhs万恶之源">FHS，万恶之源</h2>
<p>在讲打包之前，需要说明一下FHS。FHS，全称文件系统层次结构标准（Filesystem Hierarchy Standard）。它定义了系统中每个区域的用途、所需要的最小构成的文件和目录，以及例外处理与矛盾处理。该标准有两层规范，第一层规范是系统根目录下面的各个目录应该要放什么文件数据，第二层是针对/usr和/var这两个目录的子目录的定义。</p>

<p>在大多数Linux发行版中都是使用的FHS标准来建立系统，而像NixOS和GNU Guix System这种使用自己编写的配置文件配置的且可重现的系统使用的是链接式（Content-Addressable）来建立系统。这种包管理方式通过在文件系统上建立一个store，包管理器将系统配置以及包定义通过编译器编译和构建之后就会把构建结果存放在store里，并通过软链接的方式链接到执行命令的文件夹下面，方便测试所编写的配置以及包是否能正常打包以及运行。</p>

<h2 id="stdenvthe-sandbox">stdenv，The sandbox</h2>
<p>Linux下面的大多数软件包基本上都是使用GNU Autotools开发和打包的，剩下的基本上是使用一些特殊的环境来开发和打包的，为了统一构建环境，Nix对这些构建环境进行整合，于是就有了标准环境（standard environment），即stdenv。</p>

<p>stdenv是一种类似于沙盒的构建环境，总共有3层，第一层是构建的工具链，第二层是抽象层，这一层主要是将底层的工具链进行包装，而第三层就是定义层，就是我们编写软件包定义的地方。</p>

<p>创建软件包一般需要如下几样东西：</p>
<ol>
  <li>软件名称</li>
  <li>软件版本</li>
  <li>构建器以及需要传入构建器的参数</li>
  <li>软件源码和该软件包的Sha256值</li>
  <li>构建该软件包所需的依赖</li>
</ol>

<h2 id="derivation构建后的软件">Derivation，构建后的软件</h2>
<p>在编写好软件包定义之后，通过在default.nix声明软件包定义，执行nix-build命令就可以构建。如果开了flake支持的话，可以用<code class="language-plaintext highlighter-rouge">nix build .#...</code>命令来构建。构建后的软件包就是Derivation，简称drv。Derivation里面的内容一般如下：</p>
<div class="language-json highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="p">{</span><span class="w">
  </span><span class="nl">"/nix/store/8wanfzmd6vk2rqsx33rdmkilnqhm1m8i-foo.drv"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
    </span><span class="nl">"outputs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"out"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"path"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/nix/store/j95dfna6sdq7nm44im29ia7n3k3s5643-foo"</span><span class="w">
      </span><span class="p">}</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"inputSrcs"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"/nix/store/5d1i99yd1fy4wkyx85iz5bvh78j2j96r-builder.sh"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"inputDrvs"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"/nix/store/2vxpxx79j3chbqspadvh0qny5pnxbq5m-bash-4.4-p23.drv"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
        </span><span class="s2">"out"</span><span class="w">
      </span><span class="p">]</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"platform"</span><span class="p">:</span><span class="w"> </span><span class="s2">"x86_64-darwin"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"builder"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/nix/store/rq1inyhyr4gddgc5gxdid38iwn7769d7-bash-4.4-p23/bin/bash"</span><span class="p">,</span><span class="w">
    </span><span class="nl">"args"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="s2">"/nix/store/5d1i99yd1fy4wkyx85iz5bvh78j2j96r-builder.sh"</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"env"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"builder"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/nix/store/rq1inyhyr4gddgc5gxdid38iwn7769d7-bash-4.4-p23/bin/bash"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"foo"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"out"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/nix/store/j95dfna6sdq7nm44im29ia7n3k3s5643-foo"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"system"</span><span class="p">:</span><span class="w"> </span><span class="s2">"x86_64-darwin"</span><span class="w">
    </span><span class="p">}</span><span class="w">
  </span><span class="p">}</span><span class="w">
</span><span class="p">}</span><span class="w">
</span></code></pre></div></div>
<p>通过drv里面的内容，Nix会构建软件包，并放入store中。</p>

<h2 id="linux-from-scratch自己动手丰衣足食">Linux From Scratch，自己动手，丰衣足食</h2>
<p>Linux From Scratch，简称LFS，它是一本手册，教你从源码构建属于你自己的Linux发行版。由于有了Nix这种可重现的包管理器，通过它，可以让我们很方便的切换LFS的版本。</p>

<p>LFS的构建过程主要分三个大步骤：构建临时系统，构建基础系统，构建用户空间。构建临时和基础系统是属于LFS的部分，构建用户空间是属于BLFS（Beyound Linux From Scratch）的部分。</p>

<p>目前我用Nix来构建LFS还停留在构建临时系统阶段，毕竟构建LFS也不是一天都能完成的。</p>

<h2 id="打包its-magic">打包，It’s magic！</h2>
<p>终于到打包的部分了。在Nix里面打包，简而言之就是编写derivation nix文件然后构建成drv的过程。下面以GNU hello为例，说明如何使用Nix打包。</p>

<p>首先创建一个工作目录，然后在工作目录里面创建三个文件：builder.sh、autotools.nix、default.nix。</p>

<p>autotools.nix的作用是对GNU Autotools进行一层抽象，具体内容如下（macOS下面要将gcc和binutils-unwrapped换成clang和clang.bintools.bintools_bin）：</p>
<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">pkgs</span><span class="p">:</span> <span class="nv">attrs</span><span class="p">:</span>
  <span class="kn">with</span> <span class="nv">pkgs</span><span class="p">;</span>
  <span class="kd">let</span> <span class="nv">defaultAttrs</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nv">builder</span> <span class="o">=</span> <span class="s2">"</span><span class="si">${</span><span class="nv">bash</span><span class="si">}</span><span class="s2">/bin/bash"</span><span class="p">;</span>
    <span class="nv">args</span> <span class="o">=</span> <span class="p">[</span> <span class="sx">./builder.sh</span> <span class="p">];</span>
    <span class="nv">buildInputs</span> <span class="o">=</span> <span class="p">[</span> <span class="nv">gnutar</span> <span class="nv">gzip</span> <span class="nv">gnumake</span> <span class="nv">gcc</span> <span class="nv">binutils-unwrapped</span> <span class="nv">coreutils</span> <span class="nv">gawk</span> <span class="nv">gnused</span> <span class="nv">gnugrep</span> <span class="p">];</span>
    <span class="nv">system</span> <span class="o">=</span> <span class="kr">builtins</span><span class="o">.</span><span class="nv">currentSystem</span><span class="p">;</span>
  <span class="p">};</span>
  <span class="kn">in</span>
  <span class="kr">derivation</span> <span class="p">(</span><span class="nv">defaultAttrs</span> <span class="o">//</span> <span class="nv">attrs</span><span class="p">)</span>
</code></pre></div></div>
<p>然后是builder.sh，这个是用来执行软件包的编译操作，具体内容如下：</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">set</span> <span class="nt">-e</span>
<span class="nb">unset </span>PATH
<span class="k">for </span>p <span class="k">in</span> <span class="nv">$buildInputs</span><span class="p">;</span> <span class="k">do
    </span><span class="nb">export </span><span class="nv">PATH</span><span class="o">=</span><span class="nv">$p</span>/bin<span class="k">${</span><span class="nv">PATH</span>:+:<span class="k">}</span><span class="nv">$PATH</span>
<span class="k">done
</span><span class="nb">tar</span> <span class="nt">-xf</span> <span class="nv">$src</span>
<span class="k">for </span>d <span class="k">in</span> <span class="k">*</span><span class="p">;</span> <span class="k">do
    if</span> <span class="o">[</span> <span class="nt">-d</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">"</span> <span class="o">]</span><span class="p">;</span> <span class="k">then
        </span><span class="nb">cd</span> <span class="s2">"</span><span class="nv">$d</span><span class="s2">"</span>
	<span class="nb">break
    </span><span class="k">fi
done</span>
./configure <span class="nt">--prefix</span><span class="o">=</span><span class="nv">$out</span>
make
make <span class="nb">install</span>
</code></pre></div></div>
<p>最后是default.nix，定义一个derivation。内容如下：</p>
<div class="language-nix highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">let</span>
  <span class="nv">pkgs</span> <span class="o">=</span> <span class="kr">import</span> <span class="o">&lt;</span><span class="nv">nixpkgs</span><span class="o">&gt;</span> <span class="p">{};</span>
  <span class="nv">mkDerivation</span> <span class="o">=</span> <span class="kr">import</span> <span class="sx">./autotools.nix</span> <span class="nv">pkgs</span><span class="p">;</span>
<span class="kn">in</span> <span class="nv">mkDerivation</span> <span class="p">{</span>
  <span class="nv">name</span> <span class="o">=</span> <span class="s2">"hello"</span><span class="p">;</span>
  <span class="nv">src</span> <span class="o">=</span> <span class="nv">pkgs</span><span class="o">.</span><span class="nv">fetchurl</span> <span class="p">{</span>
    <span class="nv">url</span> <span class="o">=</span> <span class="s2">"https://mirror.sjtu.edu.cn/gnu/hello/hello-2.10.tar.gz"</span><span class="p">;</span>
    <span class="nv">sha256</span> <span class="o">=</span> <span class="s2">"0ssi1wpaf7plaswqqjwigppsg5fyh99vdlb9kzl7c9lng89ndq1i"</span><span class="p">;</span>
  <span class="p">};</span>
<span class="p">}</span>
</code></pre></div></div>
<p>然后使用nix-build命令构建它，当构建完成之后，就可以使用<code class="language-plaintext highlighter-rouge">./result/bin/hello</code>运行它了，之后你就可以把它放到你的Nix软件包仓库里。后续可以通过搭建ci服务器来自动构建它并建立镜像服务器，使得其他用户可以快速使用你打包的软件包。</p>

<h1 id="结束the-end">结束，The end</h1>
<p>用Nix构建一个LFS系统除了要打包软件包之外，还需要编写系统模块。这个等我构建完基础系统之后给大家讲述如何用Nix编写系统模块。下次会讲述用Nix创建自己的软件仓库，另外如果有会Nix的大佬可以加入到LFS的构建中，地址在<a href="https://github.com/c4dr01d/nix-lfs">这里</a>，欢迎各位大佬加入。</p>


    </main><footer>
  Powered by Jekyll and GNU Guix, designed by <a href="https://github.com/c4dr01d" target="_blank">c4droid</a>. Since 2021
</footer>
</div>
  </body>
</html>
